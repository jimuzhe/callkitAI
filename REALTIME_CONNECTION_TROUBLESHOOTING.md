# å®æ—¶å¯¹è¯è¿æ¥é—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°
ç‚¹å‡»å®æ—¶å¯¹è¯è¿æ¥åä¸€ç›´é‡è¿ï¼Œæ— æ³•æˆåŠŸå»ºç«‹è¿æ¥ã€‚

## å¯èƒ½çš„åŸå› 

### 1. ç½‘ç»œé…ç½®é—®é¢˜
**ç—‡çŠ¶**: æ—¥å¿—ä¸­æ˜¾ç¤ºä¸æ–­é‡è¿
**åŸå› **: 
- å°æ™ºæœåŠ¡å™¨åœ°å€é…ç½®ä¸æ­£ç¡®
- ç½‘ç»œè¿æ¥ä¸ç¨³å®š
- é˜²ç«å¢™é˜»æ­¢WebSocketè¿æ¥

### 2. è®¤è¯é—®é¢˜
**ç—‡çŠ¶**: è¿æ¥å»ºç«‹ä½†ç«‹å³æ–­å¼€
**åŸå› **:
- access_token æœªè®¾ç½®æˆ–å·²è¿‡æœŸ
- device_id æˆ– client_id é…ç½®é”™è¯¯

### 3. hello è¶…æ—¶
**ç—‡çŠ¶**: è¿æ¥å»ºç«‹ä½†æ²¡æœ‰æ”¶åˆ° hello æ¶ˆæ¯
**åŸå› **:
- æœåŠ¡å™¨å“åº”è¶…æ—¶
- WebSocketæ¶ˆæ¯æ ¼å¼ä¸åŒ¹é…
- æœåŠ¡å™¨ç«¯é”™è¯¯

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥æ—¥å¿—
åœ¨åº”ç”¨ä¸­æ‰“å¼€è°ƒè¯•é¢æ¿ï¼ŒæŸ¥æ‰¾ä»¥ä¸‹å…³é”®æ—¥å¿—ï¼š

```
ğŸ“¡ å‡†å¤‡å»ºç«‹è¿æ¥ (å®æ—¶æ¨¡å¼)
   WsUrl: wss://...
   DeviceId: ...
   ClientId: ...
   Tokené•¿åº¦: ...
```

**æ£€æŸ¥è¦ç‚¹**:
- âœ… WsUrl æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯ `wss://api.tenclass.net/xiaozhi/v1/`ï¼‰
- âœ… DeviceId å’Œ ClientId æ˜¯å¦å·²ç”Ÿæˆ
- âœ… Token é•¿åº¦ï¼ˆå¦‚æœéœ€è¦è®¤è¯ï¼‰

### æ­¥éª¤2: æŸ¥çœ‹è¿æ¥æ—¥å¿—
```
Connecting WS -> uri: wss://...
WebSocket è¿æ¥æˆåŠŸ, session: ...
```

**æ£€æŸ¥è¦ç‚¹**:
- âŒ å¦‚æœæ²¡æœ‰"WebSocket è¿æ¥æˆåŠŸ"ï¼Œè¯´æ˜æ— æ³•å»ºç«‹WebSocketè¿æ¥
- âŒ å¦‚æœæ²¡æœ‰ session IDï¼Œè¯´æ˜æ²¡æœ‰æ”¶åˆ° hello æ¶ˆæ¯

### æ­¥éª¤3: æŸ¥çœ‹é”™è¯¯æ—¥å¿—
```
âŒ WebSocket stream error: ...
âŒ æœåŠ¡å™¨é”™è¯¯: ...
ğŸ”„ å°†åœ¨ X ç§’åå°è¯•ç¬¬ N æ¬¡é‡è¿...
```

**æ£€æŸ¥è¦ç‚¹**:
- é”™è¯¯ä¿¡æ¯å†…å®¹
- é‡è¿æ¬¡æ•°ï¼ˆè¶…è¿‡6æ¬¡ä¼šæ”¾å¼ƒï¼‰

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ£€æŸ¥ç½‘ç»œè¿æ¥

```dart
// åœ¨åº”ç”¨å¯åŠ¨æ—¶æµ‹è¯•ç½‘ç»œ
1. æ‰“å¼€è®¾ç½®é¡µé¢
2. æŸ¥çœ‹ VoIP Push Token çŠ¶æ€
3. ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
```

### æ–¹æ¡ˆ2: é‡ç½®æœåŠ¡é…ç½®

æ·»åŠ ä¸€ä¸ªé‡ç½®æŒ‰é’®æ¸…é™¤ç¼“å­˜çš„é…ç½®ï¼š

```dart
// åœ¨è®¾ç½®é¡µé¢æ·»åŠ 
await SharedPreferences.getInstance().then((prefs) {
  prefs.remove('xiaozhi_device_id');
  prefs.remove('xiaozhi_client_id');
  prefs.remove('xiaozhi_access_token');
});
```

### æ–¹æ¡ˆ3: æ‰‹åŠ¨é…ç½®æœåŠ¡å™¨åœ°å€

å¦‚æœé»˜è®¤æœåŠ¡å™¨æ— æ³•è®¿é—®ï¼Œå¯ä»¥é…ç½®è‡ªå·±çš„å°æ™ºæœåŠ¡å™¨ï¼š

```dart
// åœ¨è®¾ç½®ä¸­æ·»åŠ æœåŠ¡å™¨åœ°å€é…ç½®
final prefs = await SharedPreferences.getInstance();
await prefs.setString('xiaozhi_ws_url', 'wss://your-server.com/xiaozhi/v1/');
await prefs.setString('xiaozhi_ota_url', 'https://your-server.com/xiaozhi/ota/');
```

### æ–¹æ¡ˆ4: å¢åŠ è¿æ¥è¶…æ—¶æ—¶é—´

ä¿®æ”¹ hello è¶…æ—¶æ—¶é—´ï¼š

```dart
// åœ¨ xiaozhi_service.dart çš„ connect æ–¹æ³•ä¸­
// å½“å‰æ˜¯ 10 ç§’ï¼Œå¯ä»¥å¢åŠ åˆ° 20 ç§’
_helloTimeoutTimer = Timer(const Duration(seconds: 20), () { // æ”¹ä¸º20ç§’
  if (_sessionId == null) {
    debugPrint('âŒ hello è¶…æ—¶ï¼Œæ–­å¼€è¿æ¥');
    disconnect();
  }
});
```

### æ–¹æ¡ˆ5: ç¦ç”¨è‡ªåŠ¨é‡è¿ï¼ˆä¸´æ—¶è¯Šæ–­ï¼‰

å¦‚æœæƒ³æš‚æ—¶ç¦ç”¨é‡è¿ä»¥æ›´æ¸…æ¥šåœ°çœ‹åˆ°é”™è¯¯ï¼š

```dart
// åœ¨ xiaozhi_service.dart ä¸­
Future<void> connect({bool realtime = false}) async {
  // åœ¨æ–¹æ³•å¼€å¤´æ·»åŠ ï¼š
  _shouldReconnect = false; // ä¸´æ—¶ç¦ç”¨é‡è¿
  _reconnectAttempts = 0;
  
  // ... å…¶ä½™ä»£ç 
}
```

## è°ƒè¯•å¢å¼º

### æ·»åŠ æ›´è¯¦ç»†çš„è¿æ¥æ—¥å¿—

è®©æˆ‘å¸®ä½ æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—æ¥è¯Šæ–­é—®é¢˜ï¼š
