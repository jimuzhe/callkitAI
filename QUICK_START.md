# CallKit AI 通话功能 - 快速开始

## ✅ 已完成的功能

现在你的应用已经支持：
1. **接听CallKit来电后在系统通话界面与小智对话**
2. **无需VoIP推送服务**（完全本地实现）
3. **自动音频会话管理**（通话时切换到语音聊天模式）
4. **智能通话结束**（AI对话结束时自动挂断CallKit）

## 🎯 功能流程

```
闹钟时间到达
    ↓
CallKit来电界面弹出
    ↓
用户点击"接听"
    ↓
保持在系统通话界面（不跳转到应用）
    ↓
音频会话切换到VoiceChat模式
    ↓
小智AI自动连接并开始对话
    ↓
用户与小智在通话界面中对话
    ↓
对话结束 或 用户挂断
    ↓
CallKit通话自动结束
    ↓
恢复正常状态
```

## 🔧 核心修改

### 1. CallKitService (`lib/services/callkit_service.dart`)

**新增功能**:
- ✅ `_currentCallId` - 跟踪当前CallKit通话ID
- ✅ `_isInCallKitSession` - 标记是否在CallKit会话中
- ✅ `_startAICallInCallKitSession()` - 在CallKit会话中启动AI对话
- ✅ `_monitorAICallAndEndCallKit()` - 监控AI状态并自动结束通话
- ✅ `_endCallKitSession()` - 结束CallKit会话
- ✅ `isInCallKitSession` getter - 检查是否在CallKit会话中
- ✅ `currentCallId` getter - 获取当前通话ID

**优化的事件处理**:
- ✅ `_handleCallAccepted()` - 接听时启动AI对话并保持CallKit激活
- ✅ `_handleCallDeclined()` - 拒接时清理状态
- ✅ `_handleCallEnded()` - 结束时停止AI对话
- ✅ `_handleCallTimeout()` - 超时时清理资源

### 2. AIService (`lib/services/ai_service.dart`)

**新增功能**:
- ✅ `_isCallKitSession` - 标记是否在CallKit会话中启动
- ✅ `_callKitCallId` - 记录关联的CallKit通话ID
- ✅ AI对话结束时自动通知CallKit挂断

**优化的逻辑**:
- ✅ 检测CallKit会话状态
- ✅ AI对话启动失败时自动结束CallKit通话
- ✅ AI对话正常结束时同步结束CallKit通话

## 📱 测试步骤

### 基础测试

1. **设置闹钟**
   ```
   1. 打开应用
   2. 创建一个1分钟后的闹钟
   3. 设置闹钟名称（例如："测试小智"）
   4. 保存闹钟
   ```

2. **锁屏等待**
   ```
   1. 锁定iPhone屏幕
   2. 等待闹钟时间到达
   ```

3. **接听通话**
   ```
   1. CallKit来电界面应该弹出
   2. 显示闹钟名称作为来电者
   3. 点击"接听"按钮
   ```

4. **验证AI对话**
   ```
   预期行为：
   - ✅ 保持在系统通话界面（不跳转到应用）
   - ✅ 听到小智的开场白（例如："早上好！该起床了～"）
   - ✅ 可以与小智对话（说话时能听到回应）
   - ✅ 界面显示通话时长
   ```

5. **结束通话**
   ```
   方式1：用户主动挂断
   - 点击通话界面的"挂断"按钮
   - AI对话应该立即停止
   
   方式2：AI对话自动结束
   - 等待AI对话结束（通常1-3分钟）
   - CallKit通话应该自动挂断
   ```

### 高级测试

1. **网络异常测试**
   ```
   1. 关闭WiFi和蜂窝数据
   2. 接听CallKit来电
   3. 验证错误处理（应该优雅降级）
   ```

2. **权限测试**
   ```
   1. 设置 > 隐私 > 麦克风 > 关闭应用权限
   2. 接听CallKit来电
   3. 验证权限提示
   ```

3. **连续测试**
   ```
   1. 连续设置3个间隔1分钟的闹钟
   2. 每个都接听并对话
   3. 验证资源正确释放
   ```

4. **中断测试**
   ```
   1. 接听CallKit来电
   2. 对话进行中时来真实电话
   3. 验证CallKit通话被正确挂断
   ```

## 🐛 调试指南

### 查看日志

**使用Xcode Console**:
```
1. 连接iPhone到Mac
2. 打开Xcode
3. Window > Devices and Simulators
4. 选择设备 > Open Console
5. 过滤: "call_clock"
```

**关键日志标记**:
- `📞` CallKit事件
- `🤖` AI对话
- `🎙️` 音频会话
- `✅` 成功
- `❌` 错误
- `⚠️` 警告
- `🔚` 结束

### 常见问题排查

**Q1: 接听后没有声音**
```
检查项:
1. 查找日志: "音频会话已切换至语音聊天模式"
2. 查找日志: "AI对话已在CallKit通话界面中启动"
3. 确认麦克风权限已授予
4. 检查音量是否为0

解决方案:
- 重新授予麦克风权限
- 检查AudioService初始化日志
- 验证网络连接
```

**Q2: CallKit通话立即结束**
```
可能原因:
1. AI服务连接失败
2. 音频会话配置失败
3. 网络不可达

解决方案:
- 检查网络连接
- 查看错误日志
- 确认小智服务地址配置正确
```

**Q3: AI对话不结束**
```
可能原因:
1. AI服务持续连接
2. 监控逻辑未触发

解决方案:
- 手动挂断CallKit通话
- 检查监控定时器日志
- 验证AICallManager状态更新
```

## 📊 性能优化建议

### 1. 降低延迟
```dart
// 在应用启动时预初始化
await AudioService.instance.initialize();
await AIService.instance.prewarmConnection();
```

### 2. 节省电量
```dart
// 限制AI对话时长
const maxCallDuration = Duration(minutes: 3);

// 在小智人格设置中添加结束提示
"如果用户已经醒来，请主动结束对话"
```

### 3. 优化音质
```dart
// 调整音频参数（在CallKitService中）
audioSessionPreferredSampleRate: 16000.0,  // 16kHz
audioSessionPreferredIOBufferDuration: 0.005,  // 5ms低延迟
```

## 🎨 用户体验优化

### 1. 自定义AI人格
```
设置 > AI人格管理 > 创建新人格
- 系统提示词: "你是一个温柔的闹钟助手..."
- 开场白: "早安！新的一天开始了～"
- 音色: 选择合适的语音
```

### 2. 优化开场白
```
建议使用占位符:
- {time} - 闹钟时间
- {alarm} - 闹钟名称
- {date} - 当前日期

示例:
"现在是{time}，{alarm}时间到了！该起床啦～"
```

### 3. 设置合理的对话流程
```
1. 开场问候（10秒）
2. 验证用户状态（"你醒了吗？"）
3. 简短对话（30-60秒）
4. 结束语（"祝你今天愉快！"）
```

## 🔐 隐私和安全

### 1. 音频隐私
- ✅ 所有音频处理在本地完成
- ✅ 仅AI对话内容通过WebSocket发送到小智服务
- ✅ 不存储对话录音（除非明确启用）

### 2. 数据传输
- ✅ 使用WebSocket安全连接（wss://）
- ✅ 音频数据实时处理，不缓存
- ✅ 闹钟数据仅本地存储

### 3. 权限管理
- ✅ 仅请求必要权限（麦克风、通知）
- ✅ 用户可随时撤销权限
- ✅ 权限被拒时优雅降级

## 📚 相关文档

- [完整集成文档](CALLKIT_AI_INTEGRATION.md) - 详细的技术文档
- [iOS配置说明](ios/README.md) - iOS平台配置
- [API文档](lib/services/) - 各服务模块文档

## 🚀 下一步

1. **测试基础功能** - 按照上述测试步骤验证
2. **自定义AI人格** - 创建适合你的闹钟助手
3. **调整对话流程** - 优化开场白和对话时长
4. **收集反馈** - 记录使用体验和问题
5. **持续优化** - 根据实际使用情况改进

## 💡 提示

- 首次使用建议在白天测试，避免影响正常睡眠
- 可以设置较短间隔的闹钟进行快速测试
- 保持网络连接稳定以获得最佳体验
- 定期查看日志以发现潜在问题

## 🎉 享受你的AI语音闹钟！

现在你可以每天被小智温柔唤醒了！如有任何问题，请查看日志或参考详细文档。
